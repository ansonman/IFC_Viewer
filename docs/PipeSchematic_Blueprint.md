# Pipe Schematic (PSC) 藍圖與開發計畫

本文件定義「Pipe Schematic Drawing」目標、功能清單、現況差距與分期開發藍圖。現階段 PSC 核心以「Pipe 軸線 + FlowTerminal 紅點」為基礎，逐步擴充為完整的管線原理圖。

---

## 1) 目標與範圍
- 目標：從 IFC 模型萃取管線拓樸，產生可閱讀、可互動、可輸出的 2D 管線原理圖。
- 範圍：管段、端點（Port/Terminal）、閥件/設備、支線分叉、系統分群、標註、著色、導出、互動。

小契約（Contract）
- 輸入：Ifc 模型（IfcStore）與可選擇之投影平面（XY/ZY/XZ）
- 輸出：
  - 即時互動 2D 視圖（可平移縮放、選取）
  - 可選擇的影像或向量輸出（PNG/SVG/PDF，分期導入）
- 失敗模式：模型缺少某些 IFC 關聯或無法解析拓樸時，提供可診斷的訊息與記錄。
- 成功準則：可視化主要管線結構與端點，清晰標註關鍵屬性，基本互動與導出可用。

---

## 2) 功能清單（Feature Set）

MVP（最小可用）
- 同一平面投影的管段軸線與端點顯示（已具備：Pipe 軸線 + FlowTerminal 紅點）。
- 平面選擇（XY/ZY/XZ）、基本視圖操作（Fit、平移、縮放）。
- 端點/節點基本著色規則（Terminal=紅色，其他默認色）。
- 基本統計與記錄（數量、投影平面、錯誤）。

核心拓展
- 拓樸建模：由 IfcPipeSegment 與 Ports 推導節點/邊的 Graph 結構（分支、匯流）。
- 實體辨識：終端、閥件、設備、配件（Elbow/Tee/Reducer）等類型分類與圖示化。
- 系統分群與篩選：按 IfcSystem 或屬性過濾顯示（顏色按系統）。
- 節點/邊標註：
  - 邊：公稱直徑/流量/材質（可選）、方向箭頭（若能推導）。
  - 節點：名稱、編號、型號（可選顯示等級）。
- 互動：
  - 點選同步 3D 高亮、TreeView 同步（已具 SelectionService，可擴充事件）。
  - 圈選/過濾、顯示/隱藏圖層（端點/管段/閥件/標註）。
- 導出：
  - 影像（PNG）
  - 向量（SVG、後續 PDF）
- 版面配置（Auto Layout）基礎：
  - 直交化（Orthogonal）與節點對齊
  - 簡單去重疊（De-overlap）與網格貼齊（Grid Snap）

進階
- 進階路由規則：保持方向一致性（例如由左至右）、最小折彎數。
- 標註層級控制：縮放感知（zoom-level aware）顯示多寡。
- 主題與圖例（Legend）：顏色規則、管徑區間、系統說明。
- 快取與效能：結果快取、漸進渲染大型模型。
- 報表輸出（CSV/Excel）：節點清單、邊清單、系統摘要。

---

## 3) 現況 vs 差距（Gap Analysis）

現況（已實作）
- 服務：`SchematicService.GeneratePipeAxesAsync`、`GeneratePipeAxesWithTerminalsAsync`。
- FlowTerminal 紅點定位：Ports（含 IfcRelNests）→ LocalPlacement，完整 placement chain 到世界座標。
- 平面選擇、2D 視圖（`SchematicViewModel`）、終端紅點上色、3D Overlay（分離指令）。
- 記錄（Trace 日誌）與錯誤處理（MessageBox 提示）。
- UI：工具列與選單、快捷鍵（Ctrl+Shift+P/F/S）。

差距（尚未實作或尚未完成）
- 拓樸建模：將管段/連接件解析為節點/邊的正式 Graph 結構（目前偏幾何線段集合）。
- 類型圖示化：閥件、設備、配件的辨識與不同圖示/符號。
- 邊與節點標註：顯示公稱直徑、方向箭頭、名稱/編號等；縮放感知顯示等級。
- 系統分群與篩選：多系統同場顯示與切換、顏色規則與圖例。
- 自動版面配置：直交化、對齊、去重疊、網格貼齊。
- 導出：SVG/PDF；PNG 也需加入（目前未提供導出工具）。
- 互動強化：圈選、多選操作、圖層切換、搜尋定位。
- 效能與快取：大型模型的計算與渲染優化。

---

## 4) 分期開發藍圖（Blueprint / Roadmap）

Phase 0（完成度強化、可視性）
- [完成] PSC 按鈕（快捷入口，核心為 Pipe 軸線+紅點）。
- [新增] 基本圖例與顏色設定面板（終端=紅色、管段=藍/黑，可調）。
- [新增] 簡易導出 PNG（Canvas → Bitmap）。

Phase 1（拓樸與標註）
- 建立 Graph 結構：節點分類（端點/閥件/設備/接頭），邊（段落）屬性。
- 邊標註：管徑（若可推導）、可選方向箭頭。
- 節點標註：名稱/編號（顯示密度可切換）。
- 系統分群與過濾，顏色依系統分類；基本圖例。

Phase 2（版面配置與互動）
- 直交化與對齊；基本去重疊；網格貼齊。
- 互動：圈選、多選、圖層切換（端點/管段/標註）、搜尋定位。
- 導出：SVG（向量）、PNG（影像）。

Phase 3（進階化與穩定）
- 進階路由與一致性（單一主方向、最小折彎）。
- 進階標註（縮放感知、屬性條件式顯示）。
- PDF 導出；報表（CSV/Excel）。
- 快取與效能優化；設定持久化；單元/整合測試補齊。

---

## 5) 風險與緩解
- IFC 多樣性：連接關係可能非標準（如以 IfcRelNests 表示），已加入多來源解析與記錄。
- 幾何退化：投影軸向與模型對齊程度不同，提供退化檢測與平面切換。
- 資料缺漏：無管徑/方向等屬性時，標註降級或以估算表示，並明示於圖例。

---

## 6) 驗收標準（Per Phase）
- Phase 1：
  - 同一系統的管段/端點可被識別並以 Graph 呈現。
  - 節點/邊基礎標註顯示可切換；PNG 導出可用。
- Phase 2：
  - 直交化與對齊明顯改善可讀性；SVG 導出可用。
  - 圈選與圖層切換可正常操作；搜尋可定位。
- Phase 3：
  - 高可讀性、可配置主題與圖例；PDF 導出與報表齊備。
  - 大模型流暢操作；基本測試通過。

---

## 7) 待辦摘要（高層級）
- Graph 建構與分類器（端點/閥/設備/接頭）。
- 標註系統（節點/邊）、方向箭頭與顯示密度控制。
- 系統過濾、圖層切換、圖例。
- 直交化布局、對齊與去重疊、網格貼齊。
- PNG/SVG/PDF 導出；CSV/Excel 報表。
- 快取與效能，設定持久化，測試。

---

附註：本藍圖建立於現有功能（Pipe 軸線 + FlowTerminal 紅點、平面選擇、2D 視圖與選取服務）之上，開發時將盡量保持 API 與 UI 穩定，逐步擴充。